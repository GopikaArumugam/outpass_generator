<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ExitEase | Security Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #7eb4ff;
      --primary-dark: #558dff;
      --secondary: #f6f9ff;
      --accent: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --text-primary: #2d4b75;
      --text-secondary: #64748b;
      --bg-gradient: linear-gradient(135deg, #d0e8ff, #f6f9ff);
      --card-bg: rgba(255, 255, 255, 0.25);
      --card-bg-solid: rgba(255, 255, 255, 0.95);
      --shadow: 0 10px 40px rgba(0, 0, 0, 0.10);
      --border-radius: 20px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      margin: 0;
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    .main-content {
      flex: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .main-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="10" r="0.5" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
      pointer-events: none;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--text-primary);
      padding: 20px 40px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .topbar .title {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 16px;
      color: var(--primary);
    }

    .topbar .title::before {
      content: 'üîí';
      font-size: 28px;
    }

    .topbar .datetime {
      background: var(--primary);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .topbar .profile {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .topbar .profile:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }

    .dashboard-main {
      display: flex;
      flex: 1;
      gap: 32px;
      padding: 32px 40px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    .activity-table-section {
      flex: 1.5;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 32px;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .activity-table-section h3 {
      margin: 0 0 24px 0;
      font-size: 20px;
      color: var(--text-primary);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .activity-table-section h3::before {
      content: 'üìä';
      font-size: 24px;
    }

    .activity-table-section .download-btn {
      align-self: flex-start;
      margin-bottom: 20px;
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .activity-table-section .download-btn::before {
      content: 'üì•';
      font-size: 16px;
    }

    .activity-table-section .download-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }

    table.activity-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    table.activity-table thead {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
    }

    table.activity-table th {
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    table.activity-table td {
      padding: 14px 12px;
      border-bottom: 1px solid #f1f5f9;
      transition: background 0.2s ease;
    }

    table.activity-table tbody tr:hover {
      background: #f8fafc;
    }

    .status-pass {
      color: var(--accent);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-fail {
      color: var(--danger);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-pass::before, .status-fail::before {
      font-size: 14px;
    }

    .side-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .camera-feed-box {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .camera-feed-box h4 {
      margin: 0 0 20px 0;
      font-size: 18px;
      color: var(--text-primary);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .camera-feed-box h4::before {
      content: 'üìπ';
      font-size: 20px;
    }

    .camera-feed-box video {
      width: 100%;
      max-width: 320px;
      border-radius: 16px;
      border: 3px solid var(--primary);
      margin-bottom: 16px;
      position: relative;
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
    }

    .camera-feed-box .button-group {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .camera-feed-box button {
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 12px;
      border: none;
      outline: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .camera-feed-box button.primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .camera-feed-box button.primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }

    .camera-feed-box button.secondary {
      background: #e2e8f0;
      color: var(--text-secondary);
      border: 2px solid #cbd5e1;
    }

    .camera-feed-box button.secondary:hover {
      background: #f1f5f9;
      border-color: var(--primary);
      color: var(--primary);
    }

    #verify-status {
      margin-top: 16px;
      font-weight: 600;
      font-size: 16px;
      text-align: center;
      padding: 12px 16px;
      border-radius: 12px;
      transition: all 0.3s ease;
      min-height: 20px;
    }

    #verify-status.verifying {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
      border: 1px solid #f59e0b;
    }

    #verify-status.success {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      color: #065f46;
      border: 1px solid var(--accent);
    }

    #verify-status.error {
      background: linear-gradient(135deg, #fee2e2, #fecaca);
      color: #991b1b;
      border: 1px solid var(--danger);
    }

    #verify-status.info {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #1e40af;
      border: 1px solid #3b82f6;
    }

    .info-panel {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 24px;
      width: 100%;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--shadow);
    }

    .info-panel h4 {
      margin: 0 0 16px 0;
      font-size: 16px;
      color: var(--text-primary);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-panel h4::before {
      content: '‚ÑπÔ∏è';
      font-size: 18px;
    }

    .info-panel .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
    }

    .info-panel .info-item:last-child {
      border-bottom: none;
    }

    .info-panel .info-label {
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 14px;
    }

    .info-panel .info-value {
      color: var(--text-primary);
      font-weight: 500;
    }

    @media (max-width: 1200px) {
      .dashboard-main {
        flex-direction: column;
        padding: 24px 20px;
      }
      .activity-table-section {
        order: 2;
      }
      .side-panel {
        order: 1;
      }
    }

    @media (max-width: 768px) {
      .topbar {
        padding: 16px 20px;
        flex-direction: column;
        gap: 16px;
      }
      .topbar .datetime {
        order: 3;
        margin-left: 0;
      }
      .dashboard-main {
        padding: 16px 10px;
      }
      .activity-table-section, .camera-feed-box, .info-panel {
        padding: 20px;
      }
      .camera-feed-box .button-group {
        flex-direction: column;
      }
      table.activity-table {
        font-size: 12px;
      }
      table.activity-table th, table.activity-table td {
        padding: 8px 6px;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .activity-table tbody tr {
      animation: fadeIn 0.3s ease;
    }

    /* Animated Background Orbs */
    .orb {
      position: absolute;
      width: 250px;
      height: 250px;
      border-radius: 50%;
      filter: blur(70px);
      animation: float 8s infinite alternate ease-in-out;
      z-index: -1;
    }
    .orb1 { background: rgba(130,180,255,0.55); top: -60px; left: -40px; }
    .orb2 { background: rgba(190,225,255,0.45); bottom: -70px; right: -50px; animation-duration: 10s; }
    .orb3 { background: rgba(160,200,255,0.35); top: 60%; left: -60px; animation-duration: 13s; }

    @keyframes float {
      0% { transform: translateY(0) translateX(0); }
      100% { transform: translateY(50px) translateX(50px); }
    }
  </style>
</head>
<body>
  <!-- Animated Background Orbs -->
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <div class="orb orb3"></div>

  <div class="main-content">
    <div class="topbar">
      <div class="title">
        Security Panel
      </div>
      <div class="datetime" id="datetime"></div>
      <div class="profile" title="Logout">
        <i>üë§</i>
      </div>
    </div>
    
    <div class="dashboard-main">
      <div class="activity-table-section">
        <h3>Recent Activity</h3>
        <button class="download-btn" id="download-btn">Download Report</button>
        <table class="activity-table">
          <thead>
            <tr>
              <th>Time</th>
              <th>Reg. No.</th>
              <th>Name</th>
              <th>Action</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="activity-table-body">
            
            <!-- More rows dynamically -->
          </tbody>
        </table>
      </div>
      <div class="side-panel">
        <div class="camera-feed-box">
          <h4>Live Camera Feed</h4>
          <video id="video" autoplay></video>
          <canvas id="canvas" style="display:none;"></canvas>
          <div class="button-group">
            <button id="verify-btn" class="primary">üì∏ Capture & Verify</button>
            <button id="toggle-camera-btn" class="secondary">üì∑ Turn Off Camera</button>
          </div>
          <div id="verify-status"></div>
        </div>
        <div class="info-panel">
          <h4>Student Information</h4>
          <!-- This will be replaced by JS -->
        </div>
      </div>
    </div>
    
  </div>
  <script>
    // Date and time updater
    function updateDateTime() {
      const now = new Date();
      const options = { month: 'short', day: '2-digit', year: 'numeric' };
      const dateStr = now.toLocaleDateString('en-US', options);
      let hours = now.getHours();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12;
      const mins = now.getMinutes().toString().padStart(2, '0');
      const timeStr = `${hours}:${mins} ${ampm}`;
      document.getElementById('datetime').textContent = `${dateStr} ${timeStr}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    // Camera logic
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const verifyBtn = document.getElementById('verify-btn');
    const toggleBtn = document.getElementById('toggle-camera-btn');
    const statusDiv = document.getElementById('verify-status');
    let streamRef = null;
    let cameraOn = false;

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function(stream) {
          streamRef = stream;
          video.srcObject = stream;
          video.play();
          cameraOn = true;
          toggleBtn.textContent = "Turn Off Camera";
        })
        .catch(function(err) {
          statusDiv.textContent = "Camera access denied.";
          toggleBtn.disabled = true;
        });
    }

    function stopCamera() {
      if (streamRef) {
        streamRef.getTracks().forEach(track => track.stop());
        video.srcObject = null;
        cameraOn = false;
        toggleBtn.textContent = "Turn On Camera";
      }
    }

    toggleBtn.onclick = function() {
      if (cameraOn) {
        stopCamera();
      } else {
        startCamera();
      }
    };

    // Start camera on page load
    startCamera();

    verifyBtn.onclick = function() {
      if (!cameraOn) {
        statusDiv.style.color = "red";
        statusDiv.textContent = "Camera is off!";
        return;
      }
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(function(blob) {
        const formData = new FormData();
        formData.append('photo', blob, 'capture.jpg');
        statusDiv.style.color = "#222";
        statusDiv.textContent = "Verifying...";
       
        fetch('/verify-student', {
          method: 'POST',
          body: formData
        })
        .then(res => res.json())
        .then(data => {
          let actionText = 'Verification';
          let statusClass = 'status-fail';
          let statusText = '‚ùå Failed';
          let name = data.outpass ? data.outpass.student_name : '';

          if (data.status === 'allowed') {
            // Fetch user info from backend
            fetch('/get-user-info', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ r_no: data.reg_number })
            })
        .then(res => res.json())
        .then(info => {
          console.log(info); // For debugging
          const infoPanel = document.querySelector('.info-panel');
          let allowedStatus = (info.allowed === undefined || info.allowed)
            ? `<span style="color:#10b981;font-weight:600;">Allowed</span>`
            : `<span style="color:#ef4444;font-weight:600;">Not Allowed</span>`;
          infoPanel.innerHTML = `
            <h4>Student Information</h4>
            <div class="info-item">
              <span class="info-label">Name:</span>
              <span class="info-value">${info.name}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Reg. No.:</span>
              <span class="info-value">${info.reg_number}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Leave Time:</span>
              <span class="info-value">${info.leave_time}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Return Time:</span>
              <span class="info-value">${info.return_time}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Reason:</span>
              <span class="info-value">${info.reason}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Status:</span>
              <span class="info-value">${allowedStatus}</span>
            </div>
          `;
          name = info.name; // Update name
        });
            // Show status
            statusDiv.style.color = 'green';
            statusDiv.textContent = `Allowed: ${data.reg_number}`;
            actionText = 'Verified';
            statusClass = 'status-pass';
            statusText = '‚úÖ Passed';
          } else if (data.status === 'no_outpass') {
            statusDiv.style.color = 'orange';
            statusDiv.textContent = `No approved outpass found`;
            document.querySelector('.info-panel').innerHTML = ''; // Clear info panel
            statusText = '‚ùå No Outpass';
          } else if (data.status === 'choose_action') {
            statusDiv.style.color = '#4e73df';
            let buttonsHtml = '';
            if (data.actions.includes('Entry')) {
              buttonsHtml += '<button id="entry-btn" style="margin:8px 8px 0 0;">Entry</button>';
            }
            if (data.actions.includes('Exit')) {
              buttonsHtml += '<button id="exit-btn" style="margin:8px 0 0 0;">Exit</button>';
            }
            statusDiv.innerHTML = `${data.message}<br>${buttonsHtml}`;
            if (data.actions.includes('Entry')) {
              document.getElementById('entry-btn').onclick = function() {
                recordAction('Entry', data.reg_number);
              };
            }
            if (data.actions.includes('Exit')) {
              document.getElementById('exit-btn').onclick = function() {
                recordAction('Exit', data.reg_number);
              };
            }
            // Don't log verification for choose_action, only log the action
            return;
          } else if (data.status === 'error') {
            statusDiv.style.color = 'red';
            statusDiv.textContent = data.message;
            document.querySelector('.info-panel').innerHTML = ''; // <-- Clear info panel
          } else {
            statusDiv.style.color = 'red';
            statusDiv.textContent = data.message || 'Not recognized';
            document.querySelector('.info-panel').innerHTML = '';
          }

          // Add to Recent Activity Table
          const tbody = document.getElementById('activity-table-body');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${new Date().toLocaleString()}</td>
            <td>${data.reg_number || ''}</td>
            <td>${name}</td>
            <td>${actionText}</td>
            <td class="${statusClass}">${statusText}</td>
          `;
          // Add new row at the top
          if (tbody.firstChild) {
            tbody.insertBefore(tr, tbody.firstChild);
          } else {
            tbody.appendChild(tr);
          }
        })
        .catch(() => {
          statusDiv.style.color = 'red';
          statusDiv.textContent = "Verification failed.";
        });
      }, 'image/jpeg');
    };

    function recordAction(action, reg_number) {
      const now = new Date();
      fetch('/record-action', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          action,
          reg_number,
          action_time: now.toISOString().slice(0, 16).replace('T', ' ') // "YYYY-MM-DD HH:MM"
        })
      })
      .then(res => res.json())
      .then(resp => {
        statusDiv.style.color = resp.status === 'success' ? 'green' : 'red';
        statusDiv.textContent = resp.message;
        const infoPanel = document.querySelector('.info-panel');
        if (resp.status === 'success') {
          infoPanel.innerHTML = `
            <h4>Student Information</h4>
            <div class="info-item">
              <span class="info-label">Name:</span>
              <span class="info-value">${resp.name || ''}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Roll No.:</span>
              <span class="info-value">${resp.roll_number || ''}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Leave Time:</span>
              <span class="info-value">${resp.leave_time || ''}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Return Time:</span>
              <span class="info-value">${resp.return_time || ''}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Action Time:</span>
              <span class="info-value">${resp.action_time || ''}</span>
            </div>
          `;
          // --- Add to Recent Activity Table ---
          const tbody = document.getElementById('activity-table-body');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${resp.action_time || ''}</td>
            <td>${resp.reg_number || resp.roll_number || ''}</td>
            <td>${resp.name || ''}</td>
            <td>${action}</td>
            <td class="${resp.status === 'success' ? 'status-pass' : 'status-fail'}">
              ${resp.status === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}
            </td>
          `;
          // Add new row at the top
          if (tbody.firstChild) {
            tbody.insertBefore(tr, tbody.firstChild);
          } else {
            tbody.appendChild(tr);
          }
          // --- End Add to Recent Activity Table ---
        } else if (resp.status === 'error' && resp.all_outpasses) {
          let html = `<div><b>No valid outpass for this action time!</b></div>`;
          resp.all_outpasses.forEach(o => {
            html += `
              <div style="margin-top:8px;">
                <div><span class="info-label">Name:</span> ${o.name}</div>
                <div><span class="info-label">Roll No.:</span> ${o.roll_number}</div>
                <div><span class="info-label">Leave Time:</span> ${o.leave_time}</div>
                <div><span class="info-label">Return Time:</span> ${o.return_time}</div>
              </div>
            `;
          });
          html += `<div><span class="info-label">Action Time:</span> ${resp.action_time}</div>`;
          infoPanel.innerHTML = html;
          // Add to Recent Activity Table
          const tbody = document.getElementById('activity-table-body');
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${new Date().toLocaleString()}</td>
            <td>${reg_number || ''}</td>
            <td></td>
            <td>${action}</td>
            <td class="status-fail">‚ùå Invalid Time</td>
          `;
          // Add new row at the top
          if (tbody.firstChild) {
            tbody.insertBefore(tr, tbody.firstChild);
          } else {
            tbody.appendChild(tr);
          }
        } else if (resp.status === 'error') {
          if (resp.message === 'No outpass found.') {
            infoPanel.innerHTML = '';
            // Add to Recent Activity Table
            const tbody = document.getElementById('activity-table-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${new Date().toLocaleString()}</td>
              <td>${reg_number || ''}</td>
              <td></td>
              <td>${action}</td>
              <td class="status-fail">‚ùå No outpass found for specific timing</td>
            `;
            // Add new row at the top
            if (tbody.firstChild) {
              tbody.insertBefore(tr, tbody.firstChild);
            } else {
              tbody.appendChild(tr);
            }
          } else {
            infoPanel.innerHTML = `
              <div><span class="info-label">Name:</span> ${resp.name || ''}</div>
              <div><span class="info-label">Roll No.:</span> ${resp.roll_number || ''}</div>
              <div><span class="info-label">Leave Time:</span> ${resp.leave_time || ''}</div>
              <div><span class="info-label">Return Time:</span> ${resp.return_time || ''}</div>
              <div><span class="info-label">Action Time:</span> ${resp.action_time || ''}</div>
            `;
          }
        }
      });
    }

    // Download report function
    document.getElementById('download-btn').onclick = function() {
      const table = document.querySelector('.activity-table');
      let csv = '';
      for (let row of table.rows) {
        let rowData = [];
        for (let cell of row.cells) {
          rowData.push('"' + cell.textContent.replace(/"/g, '""') + '"');
        }
        csv += rowData.join(',') + '\n';
      }
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'activity_report.csv';
      a.click();
      URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
