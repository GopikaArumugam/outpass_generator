<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Outpass Chatbot</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
/* ----------- GLOBAL MATCHES LOGIN PAGE ----------- */
body {
  margin: 0;
  font-family: Poppins, sans-serif;
  background: linear-gradient(135deg, #d0e8ff, #f6f9ff);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

/* Floating Orbs (Same as Login Page) */
.orb {
  position: absolute;
  width: 250px;
  height: 250px;
  border-radius: 50%;
  filter: blur(70px);
  animation: float 8s infinite alternate ease-in-out;
  z-index: 1;
}

.orb1 { background: rgba(130,180,255,0.55); top: -60px; left: -40px; }
.orb2 { background: rgba(190,225,255,0.45); bottom: -70px; right: -50px; animation-duration: 10s; }
.orb3 { background: rgba(160,200,255,0.35); top: 60%; left: -60px; animation-duration: 13s; }

@keyframes float {
  0% { transform: translateY(0) translateX(0); }
  100% { transform: translateY(40px) translateX(40px); }
}

/* ----------- CHAT CONTAINER (GLASS STYLE) ---------- */
.chat-container {
  width: 420px;
  height: 90vh;
  border-radius: 25px;
  background: rgba(255,255,255,0.30);
  backdrop-filter: blur(18px);
  border: 1px solid rgba(255,255,255,0.45);
  box-shadow: 0 10px 40px rgba(0,0,0,0.12);
  display: flex;
  flex-direction: column;
  z-index: 5;
}

/* ----------- HEADER ---------- */
.chat-header {
  background: linear-gradient(135deg, #7eb4ff, #558dff);
  color: white;
  padding: 18px 22px;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-top-left-radius: 25px;
  border-top-right-radius: 25px;
}

/* Buttons inside header */
.action-btn {
  background: rgba(255,255,255,0.25);
  padding: 8px 12px;
  border-radius: 10px;
  border: none;
  font-size: 14px;
  color: white;
  cursor: pointer;
  transition: 0.25s;
}

.action-btn:hover {
  background: rgba(255,255,255,0.35);
}

/* Avatar style to match theme */
.avatar {
  width: 38px;
  height: 38px;
  border-radius: 50%;
  background: white;
  border: 2px solid #7eb4ff;
}

/* ----------- CHAT BODY ---------- */
.chat-body {
  flex: 1;
  overflow-y: auto;
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* Chat bubbles (glass-like feel) */
.bubble {
  max-width: 75%;
  padding: 14px 18px;
  border-radius: 20px;
  animation: fadeIn 0.25s ease;
  backdrop-filter: blur(10px);
}

.bot {
  background: rgba(255,255,255,0.55);
  border: 1px solid rgba(180,200,255,0.4);
  color: #2d4b75;
  align-self: flex-start;
}

.user {
  background: linear-gradient(135deg, #7eb4ff, #558dff);
  color: white;
  box-shadow: 0 4px 12px rgba(120,150,255,0.4);
  align-self: flex-end;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ----------- OPTION BUTTONS ---------- */
.options {
  background: rgba(255,255,255,0.20);
  border: 1px solid rgba(200,220,255,0.4);
  padding: 12px;
  border-radius: 14px;
  backdrop-filter: blur(10px);
  display: flex;
  gap: 8px;
}

.options button {
  padding: 10px 20px;
  border: none;
  border-radius: 25px;
  background: linear-gradient(135deg, #7eb4ff, #558dff);
  color: white;
  cursor: pointer;
  font-weight: 600;
  transition: 0.25s;
  box-shadow: 0 4px 14px rgba(120,150,255,0.2);
}

.options button:hover {
  transform: translateY(-3px);
}

/* ----------- INPUT AREA ---------- */
.input-container {
  padding: 12px;
  border-top: 1px solid rgba(200,220,255,0.4);
  background: rgba(255,255,255,0.40);
  backdrop-filter: blur(12px);
  display: none;
}

/* Input boxes matching login page */
.input-container input,
.input-container select {
  width: 100%;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid rgba(120,150,200,0.4);
  background: rgba(255,255,255,0.65);
  font-size: 15px;
  transition: 0.3s;
}

.input-container input:focus,
.input-container select:focus {
  border-color: #7eb4ff;
  box-shadow: 0 0 8px rgba(126,180,255,0.4);
}

/* Submit button */
.submit-btn {
  width: 100%;
  margin-top: 6px;
  padding: 13px;
  border-radius: 12px;
  background: linear-gradient(135deg, #7eb4ff, #558dff);
  color: white;
  font-weight: 600;
  border: none;
  transition: 0.25s;
}

.submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(120,150,255,0.35);
}

/* ----------- PROFILE POPUP ---------- */
.profile-popup {
  position: absolute;
  top: 70px;
  right: 20px;
  width: 240px;
  background: rgba(255,255,255,0.35);
  border-radius: 14px;
  border: 1px solid rgba(200,220,255,0.4);
  backdrop-filter: blur(15px);
  padding: 16px;
  display: none;
}

.logout-btn {
  width: 100%;
  padding: 10px;
  border-radius: 12px;
  border: none;
  background: #ff6b6b;
  color: white;
  font-weight: 600;
}
</style>

</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <div class="title">EXITEASE - OUTPASS GENERATOR</div>
      <div class="actions">
      </div>
    </div>

    <div class="chat-body" id="chat-body">
      <div class="bubble bot">Hey {{ name }}, what would you like to do today?</div>
    </div>

    <div class="options" id="options">
      <button onclick="choose('Generate Outpass')">Generate Outpass</button>
      <button onclick="choose('Leave/OD Request')">Leave/OD Request</button>
      <button onclick="choose('Check Status')">Check Status</button>
    </div>

    <div class="input-container" id="input-container">
      <input type="text" id="input" placeholder="Type your response..." />
    </div>
  </div>

  <script>
    const rollNumber = "{{ roll_number }}"; // Roll number passed from backend
  </script>

  <script>
    let step = 0;
    let category = "", reason = "", time = "";

    const reasonCategories = {
      "Medical": ["Medical Appointment", "Feeling Unwell", "Hospital Visit"],
      "Personal": ["Personal Reason", "Family Emergency", "Visiting Home", "Family Function", "Relative's Illness", "Funeral Attendance"],
      "Academic": ["Attending Seminar/Workshop", "Project Work Outside Campus", "Exam Outside Campus"],
      "Official": ["Government Work", "Bank Work"],
      "Others": ["Sports Event", "College Fest Participation", "Cultural Program", "Club Activity"] // New category added
    };

    function submitOutpassRequest() {
      const reason = document.getElementById('reason').value.trim();
      const leaveTime = document.getElementById('leave-time').value.trim();

      const validReasons = ["Medical", "Personal", "Family"];
      if (!validReasons.includes(reason)) {
        document.getElementById('chat-body').innerHTML += `<div class="bubble bot">Invalid reason. Please choose from 'Medical', 'Personal', or 'Family'.</div>`;
        return;
      }

      fetch('/create_outpass', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          category: category,
          reason: reason,
          leave_time: leaveTime
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          document.getElementById('chat-body').innerHTML += `<div class="bubble bot">Outpass created! ID: ${data.outpass_id}</div>`;
        } else {
          document.getElementById('chat-body').innerHTML += `<div class="bubble bot">Error: ${data.message}</div>`;
        }
      });
    }

    function choose(option) {
      append('user', option);
      document.getElementById('options').style.display = 'none';

      if (option === "Generate Outpass") {
        step = 1;
        ask("What is the reason category?");
        displayCategoryOptions();
      } else if (option === "Check Status") {
        checkStatus(); // Use the same function for consistency
      } else {
        append('bot', "That feature is coming soon.");
      }
    }

    function displayCategoryOptions() {
      const inputContainer = document.getElementById('input-container');
      inputContainer.style.display = 'block';
      inputContainer.innerHTML = ''; // Clear any existing content
      inputContainer.classList.add('options'); // Add the 'options' class for styling

      Object.keys(reasonCategories).forEach(category => {
        const button = document.createElement('button');
        button.textContent = category;
        button.className = 'category-btn'; // Ensure the button has the correct class
        button.onclick = () => handleCategorySelection(category);
        inputContainer.appendChild(button);
      });
    }

    function handleCategorySelection(category) {
      append('user', category);
      step = 2;
      ask("Please select the specific reason.");
      displayReasonOptions(category);
    }

    function displayReasonOptions(category) {
      const inputContainer = document.getElementById('input-container');
      inputContainer.innerHTML = ''; // Clear any existing content
      inputContainer.classList.add('options'); // Add the 'options' class for styling

      reasonCategories[category].forEach(reason => {
        const button = document.createElement('button');
        button.textContent = reason;
        button.className = 'reason-btn'; // Ensure the button has the correct class
        button.onclick = () => handleReasonSelection(reason);
        inputContainer.appendChild(button);
      });
    }

    function handleReasonSelection(selectedReason) {
      reason = selectedReason; // Update the global reason variable
      console.log('Selected reason:', reason); // Debugging log
      append('user', reason);
      step = 3;
      ask("What time do you plan to leave?");
      askForLeaveTime(); // Ask for leaving time first
    }

    function ask(text) {
      append('bot', text);
    }

    function append(type, text, isHtml = false) {
      const chat = document.getElementById('chat-body');
      const div = document.createElement('div');
      div.className = `bubble ${type}`;
      if (isHtml) {
        div.innerHTML = text; // Render HTML content
      } else {
        div.textContent = text;
      }
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function showInput() {
      const inputContainer = document.getElementById('input-container');
      inputContainer.innerHTML = `
        <input type="text" id="input" placeholder="Type your response..." />
      `;
      const input = document.getElementById('input');
      input.focus();

      input.onkeydown = function (e) {
        if (e.key === "Enter") {
          const msg = input.value.trim();
          if (!msg) return;
          input.value = '';
          inputContainer.style.display = 'none';
          handle(msg);
        }
      };
    }

    function handle(msg) {
      append('user', msg);
      if (step === 3) {
        const time = msg;
        append('bot', "Submitting your request...");
        fetch('/finalize_outpass', {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ category, reason, leave_time: time })
        }).then(res => res.json()).then(data => {
          if (data.status === 'success') {
            append('bot', `Outpass created! ID: ${data.outpass_id}`);
          } else {
            append('bot', `Error: ${data.message}`);
          }
        });
      }
    }

    function toggleProfile() {
      const profilePopup = document.getElementById('profilePopup');
      profilePopup.style.display = (profilePopup.style.display === 'block') ? 'none' : 'block';
    }

    function logout() {
      window.location.href = "/logout";
    }

    function askForLeaveTime() {
      const inputContainer = document.getElementById('input-container');
      inputContainer.innerHTML = ''; // Clear any existing content
      inputContainer.style.display = 'block';

      // Create a container for leaving date and time
      const leaveRow = document.createElement('div');
      leaveRow.className = 'date-time-row';

      const leaveDatePicker = document.createElement('input');
      leaveDatePicker.type = 'date';
      leaveDatePicker.id = 'leave-date';
      leaveDatePicker.className = 'picker-input';
      leaveDatePicker.min = new Date().toISOString().split('T')[0]; // Today's date
      const maxDate = new Date();
      maxDate.setDate(maxDate.getDate() + 10); // 10 days from today
      leaveDatePicker.max = maxDate.toISOString().split('T')[0]; // Restrict to 10 days from today

      const leaveHourPicker = document.createElement('select');
      leaveHourPicker.id = 'leave-hour';
      leaveHourPicker.className = 'picker-scroll';
      for (let hour = 6; hour < 18; hour++) {
        const option = document.createElement('option');
        option.value = hour.toString().padStart(2, '0');
        option.textContent = hour.toString().padStart(2, '0');
        leaveHourPicker.appendChild(option);
      }

      const leaveMinutePicker = document.createElement('select');
      leaveMinutePicker.id = 'leave-minute';
      leaveMinutePicker.className = 'picker-scroll';
      for (let minute of [0, 15, 30, 45]) {
        const option = document.createElement('option');
        option.value = minute.toString().padStart(2, '0');
        option.textContent = minute.toString().padStart(2, '0');
        leaveMinutePicker.appendChild(option);
      }

      leaveRow.appendChild(leaveDatePicker);
      leaveRow.appendChild(leaveHourPicker);
      leaveRow.appendChild(leaveMinutePicker);

      // Create a submit button for leaving time
      const submitButton = document.createElement('button');
      submitButton.textContent = 'Next';
      submitButton.className = 'submit-btn';
      submitButton.onclick = () => handleLeaveTimeSelection();

      // Append elements to the input container
      inputContainer.appendChild(leaveRow);
      inputContainer.appendChild(submitButton);
    }

    function askForReturnTime(leaveDateTime) {
      const inputContainer = document.getElementById('input-container');
      inputContainer.innerHTML = ''; // Clear any existing content
      inputContainer.style.display = 'block';

      // Create a container for returning date and time
      const returnRow = document.createElement('div');
      returnRow.className = 'date-time-row';

      const returnDatePicker = document.createElement('input');
      returnDatePicker.type = 'date';
      returnDatePicker.id = 'return-date';
      returnDatePicker.className = 'picker-input';
      returnDatePicker.min = leaveDateTime.split(' ')[0]; // Ensure returning date is not before leaving date

      const returnHourPicker = document.createElement('select');
      returnHourPicker.id = 'return-hour';
      returnHourPicker.className = 'picker-scroll';
      for (let hour = 6; hour < 18; hour++) {
        const option = document.createElement('option');
        option.value = hour.toString().padStart(2, '0');
        option.textContent = hour.toString().padStart(2, '0');
        returnHourPicker.appendChild(option);
      }

      const returnMinutePicker = document.createElement('select');
      returnMinutePicker.id = 'return-minute';
      returnMinutePicker.className = 'picker-scroll';
      for (let minute of [0, 15, 30, 45]) {
        const option = document.createElement('option');
        option.value = minute.toString().padStart(2, '0');
        option.textContent = minute.toString().padStart(2, '0');
        returnMinutePicker.appendChild(option);
      }

      returnRow.appendChild(returnDatePicker);
      returnRow.appendChild(returnHourPicker);
      returnRow.appendChild(returnMinutePicker);

      // Create a submit button for returning time
      const submitButton = document.createElement('button');
      submitButton.textContent = 'Submit';
      submitButton.className = 'submit-btn';
      submitButton.onclick = () => handleReturnTimeSelection(leaveDateTime);

      // Append elements to the input container
      inputContainer.appendChild(returnRow);
      inputContainer.appendChild(submitButton);
    }

    function handleLeaveTimeSelection() {
      const leaveDate = document.getElementById('leave-date').value;
      const leaveHour = document.getElementById('leave-hour').value;
      const leaveMinute = document.getElementById('leave-minute').value;

      if (!leaveDate || !leaveHour || !leaveMinute) {
        append('bot', 'Please select a valid leaving date and time.');
        return;
      }

      // Construct the leave time string manually
      const leaveDateTime = `${leaveDate} ${leaveHour}:${leaveMinute}`;

      // Validate that the leaving time is between 6:00 AM and 6:00 PM
      const leaveHourInt = parseInt(leaveHour, 10);
      if (leaveHourInt < 6 || leaveHourInt >= 18) {
        append('bot', 'Leaving time must be between 6:00 AM and 6:00 PM.');
        return;
      }

      append('user', `Leaving: ${leaveDateTime}`);
      ask("What time do you plan to return?");
      askForReturnTime(leaveDateTime); // Proceed to ask for returning time
    }

    function handleReturnTimeSelection(leaveDateTime) {
      const returnDate = document.getElementById('return-date').value;
      const returnHour = document.getElementById('return-hour').value;
      const returnMinute = document.getElementById('return-minute').value;

      if (!returnDate || !returnHour || !returnMinute) {
        append('bot', 'Please select a valid returning date and time.');
        return;
      }

      // Construct the return time string manually
      const returnDateTime = `${returnDate} ${returnHour}:${returnMinute}`;

      // Validate that the returning time is between 6:00 AM and 6:00 PM
      const returnHourInt = parseInt(returnHour, 10);
      if (returnHourInt < 6 || returnHourInt >= 18) {
        append('bot', 'Returning time must be between 6:00 AM and 6:00 PM.');
        return;
      }

      // Ensure returning time is after leaving time
      if (new Date(`${returnDate}T${returnHour}:${returnMinute}`) <= new Date(`${leaveDateTime.replace(' ', 'T')}`)) {
        append('bot', 'Returning time must be after the leaving time.');
        return;
      }

      append('user', `Returning: ${returnDateTime}`);
      append('bot', 'Submitting your request...');

      handleSubmitOutpassRequest(leaveDateTime, returnDateTime);
    }

    function handleSubmitOutpassRequest(leaveDateTime, returnDateTime) {
      if (!reason || reason.trim() === '') {
        append('bot', 'Please select a valid reason.');
        return;
      }

      // Check if the leave date is today
      const leaveDate = leaveDateTime.split(' ')[0];
      const today = new Date().toISOString().split('T')[0];
      const isEmergency = leaveDate === today; // Automatically mark as emergency if leave date is today

      console.log('Submitting payload:', {
        roll_number: rollNumber,
        reason: reason,
        leave_time: leaveDateTime,
        return_time: returnDateTime,
        is_emergency: isEmergency
      }); // Debugging log

      fetch('/create_outpass', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          roll_number: rollNumber,
          reason: reason,
          leave_time: leaveDateTime,
          return_time: returnDateTime,
          is_emergency: isEmergency // Include the emergency flag
        })
      })
        .then(res => res.json())
        .then(data => {
          const inputContainer = document.getElementById('input-container');
          if (data.status === 'success') {
            append('bot', 'Outpass request sent successfully!');
            inputContainer.innerHTML = ''; // Clear the input container
            replaceWithCheckStatusButton(); // Replace input container with "Check Status" button
          } else {
            append('bot', `Error: ${data.message || 'An unknown error occurred.'}`); // Display the specific error message
            replaceWithRefreshButton(); // Replace submit button with refresh button
          }
        })
        .catch(error => {
          console.error('Error submitting request:', error);
          append('bot', 'An error occurred while submitting your request. Please try again.');
          replaceWithRefreshButton(); // Replace submit button with refresh button
        });
    }
    

    function replaceWithCheckStatusButton() {
      const inputContainer = document.getElementById('input-container');
      inputContainer.innerHTML = ''; // Clear the input container

      // Create the "Check Status" button
      const checkStatusButton = document.createElement('button');
      checkStatusButton.textContent = 'Check Status';
      checkStatusButton.className = 'submit-btn';
      checkStatusButton.onclick = () => checkStatus();

      // Append the button to the input container
      inputContainer.appendChild(checkStatusButton);
    }

    function checkStatus() {
      append('bot', "Checking your status...");
      fetch('/check_status', {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            const outpasses = data.outpasses;
    
            // Format and display all outpasses
            let formattedDetails = `
              <div style="border: 1px solid #ccc; padding: 10px; border-radius: 8px; background-color: #f9f9f9;">
                <h4 style="margin-bottom: 10px;">Outpass Requests</h4>
            `;
    
            outpasses.forEach(outpass => {
              formattedDetails += `
                <div style="margin-bottom: 15px;">
                  <p><strong>Requested Date:</strong> ${outpass.requested_date}</p>
                  <p><strong>Leave Time:</strong> ${outpass.leave_time}</p>
                  <p><strong>Return Time:</strong> ${outpass.return_time}</p>
                  <p><strong>Reason:</strong> ${outpass.reason}</p>
                  <p><strong>Status:</strong> ${outpass.status}</p>
                </div>
                <hr>
              `;
            });
    
            formattedDetails += `</div>`;
            append('bot', formattedDetails, true); // Pass 'true' to allow HTML rendering
          } else {
            append('bot', `Error: ${data.message}`);
          }
        })
        .catch(error => {
          console.error('Error checking status:', error);
          append('bot', 'An error occurred while checking your status. Please try again.');
        });
    }
    

    function formatTime(timeString) {
      // Parse the time string (e.g., "2025-05-04 06:00")
      const [date, time] = timeString.split(' ');
      const [year, month, day] = date.split('-');
      const [hour, minute] = time.split(':');

      // Format the time as "DD/MM/YYYY HH:MM"
      return `${day}/${month}/${year} ${hour}:${minute}`;
    }

    function replaceWithRefreshButton() {
      const inputContainer = document.getElementById('input-container');
      inputContainer.innerHTML = ''; // Clear the input container

      // Create the "Refresh" button
      const refreshButton = document.createElement('button');
      refreshButton.textContent = 'Refresh';
      refreshButton.className = 'submit-btn';
      refreshButton.onclick = () => location.reload(); // Reload the page when clicked

      // Append the refresh button to the input container
      inputContainer.appendChild(refreshButton);
    }
  </script>
</body>
</html>
